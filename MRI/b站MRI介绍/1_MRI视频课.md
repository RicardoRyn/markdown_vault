# 核磁共振物理基础

在**主磁场B0**的作用下，大脑中的**氢离子**（1个质子，0个电子；也可以直接叫**质子**）会分成2个能级：

- 高能级，与主磁场反向（数量更少）
- 低能级，与主磁场**同向**（数量更多）

以低能级质子举例，其自旋产生的磁场方向并不总是与主磁场100%平行（可能只有99%平行），这意味着一个一个质子除了**自旋**之外，还会以B0为轴，发生旋转，称之为**进动**，绕B0旋转的频率称为**进动频率(ω0)**

拉莫尔方程：
$$
\omega_0 = \gamma B_0 \\
\gamma: 磁旋比，常数 \\
$$
**进动频率只与主磁场大小有关，主磁场越大，进动频率越大，质子进动越快**

进动的质子，**磁矩**可以分解：

- **纵向分量（纵向磁矩）Mz**：平行于B0方向
- **横向分量（横向磁矩）Mxy**：垂直B0方向

大脑中所有质子的磁矩叠加：横向分量由于旋转，完全抵消了；纵向分量上，由于低能级质子更多，所以总会产生一个**沿着B0方向**的**宏观磁化量M0**

***磁共振现象***：先别问我为什么会有这个现象；你只需要知道，对脑子施加一个射频脉冲，只要**射频频率 = 进动频率**，M0就会发生**倾倒（旋转着倒塌）**。以上一个描述属于**经典力学**视角。



从**量子力学**视角来看

**能量差公式**：
$$
\begin{flalign}
\Delta E &= \gamma \hbar B_0 \\
&= \hbar \omega_0 \\
\hbar: 约化普朗克常量，常数
\end{flalign}
$$
**射频脉冲能量公式**：
$$
\begin{flalign}
E & = \hbar \omega_1 \\
\omega_1: 射频频率
\end{flalign}
$$
量子力学规定，如果射频脉冲和能极差相等，**低能级质子就会吸收能量，跃迁至高能级**。



足够的低能级质子跃迁至高能级，导致**Mz减少，直至为0**

但为什么说是倾倒呢？因为脉冲对质子还有另一个作用——**相聚合**。

相位聚合，从而**得到一个绕B0旋转**的**横向磁化量Mxy**。（如果脉冲消失，称之为**失相**，Mz恢复，Mxy消失，这两个磁分量恢复的过程称为**弛豫**）



生物组织的弛豫时间在10的-5次方秒到几秒之间，Mz和Mxy随时间变化如图：

![image-20230824153515665](..\..\..\typora_images\image-20230824153515665.png)

>习惯：
>
>- 将纵向磁化量恢复至63%M0的时间定义为T1
>
>- 将横向磁化量下降至37%M0的时间定义为T2
>
>图上的横向磁分量公式不全面，还有一个修正后的横向磁分量公式。



# 质子密度加权成像

**信号**由横向磁分量产生，横向磁分量绕B0旋转，因此在周围放上线圈，横向磁分量Mxy与线圈切割，产生电信号，由于弛豫过程中，Mxy不断减小，因此产生一个不断衰减的电信号，称为**自由感应衰减信号（FID）**：

![image-20230824154243115](..\..\..\typora_images\image-20230824154243115.png)

根据信号强度公式、横向磁分量与大磁体M0关系公式等（此处未放）得到的几个事实：

1. **信号强度ε**与**横向磁分量**的大小成正比，弛豫过程中，Mxy不断衰减，信号也不断衰减
2. **横向磁分量Mxy**和**宏观磁化量M0**成正比，M0又与质子数成正比，即：质子密度ρ——质子数N——宏观磁化量M0——横向磁化量Mxy——信号强度ε——图像亮度。**质子密度加权成像**，即为核磁共振成像的基石。

质子密度加权成像效果并不理想，对比度不够，轮廓模糊



# T2加权成像

![image-20230824155610136](..\..\..\typora_images\image-20230824155610136.png)

由于生物组织的特性，例如：白质的横向磁分量衰减的很快，仅仅90ms就衰减到只有37%，而脑脊液则需要1000ms。

此时，我们选择在脉冲消失后2000ms时采集信号，白质的横向磁分量信号已经衰减殆尽，产生的信号微乎其微，脑脊液却还保留着20%的信号强度，组织之间对比明显。



# T1加权成像

T1加权的信号来自纵向磁分量，而纵向磁分量总是与线圈平行，无法切割产生信号。

因此通常在射频消失后（此时纵向磁分量正在恢复中，横向磁分量正在消失中），将尚未恢复完全的纵向磁分量再次打倒，使纵向磁分量又产生横向磁分量，这个横向磁分量切割线圈，就能产生信号

还是由于生物组织的特性，例如：脑脊液的恢复时间最慢，脑白质的恢复时间最快，所以在打倒纵向磁分量的那一瞬间，脑白质的Mz更大，最后产生的信号更大，在图上看着更亮，和T2刚好相反。

![image-20230824161241395](..\..\..\typora_images\image-20230824161241395.png)



**FLAIR**：Fluid Attenuated Inversion Recovery，液体抑制反转恢复。通过加权的方式，抑制了脑脊液的信号，使图像中的脑脊液为黑色，肿瘤（亮）就更容易被识别（其他组织类似T2加权像，白质更暗，灰质更亮）。



# 定位

![image-20230824162411673](..\..\..\typora_images\image-20230824162411673.png)

用箭头表示每一层主磁场的大小，即在没有梯度磁场的帮助下，由于B0磁场均匀，则每一层的质子进动频率就一致。

通过梯度场与主磁场的共同作用，不同层（这里指沿着z轴，从脖子到头顶的每一层）的质子进动频率就形成梯度变化。

假设从脖子到头顶每一层的进动频率分别为：62MHz，63MHz，64MHz，65MHz，66MHz，67MHz；此时施加的射频脉冲如果是64MHz，则只有第3层的质子会发生**核磁共振现象**（简称**共振**），这一过程称为**选层**。**此时脑子外的接收线圈接收到的信号就之来源于这个薄层（64MHz的第3层）**。

选层结束后，暂时不再有射频脉冲施加，也就是说只有第3层的质子们能够切割磁感线产生信号，所以所接收的信号一定是来自第3层的质子，所以可以只关注第3层的质子。



那么如何仅通过一个信号，获取层上各位置的质子含量？傅里叶变换

考虑第三层的x轴与y轴，x从左耳到右耳，y从后脑勺到鼻子

在选层结束的瞬间，第3层所有位置上的质子处于共振状态，进动频率相等（64MHz），相位相同

首先在y轴上施加梯度场，导致沿着y轴的不同层的质子具有不同的进动频率，持续一段时间，移除这个梯度场沿着y轴的梯度场，则所有层（指沿着y轴的层）质子均恢复到统一进动频率（64MHz），**但是不同层质子具有不同相位**——**相位编码**

再在x轴上施加梯度场，导致沿着x轴的不同层的质子进动频率不同——**频率编码**

**频率编码的同时，接收线圈开始接收信号**，此时接收到的信号即包括：整个层内，**所有质子切割线圈产生的信号而叠加成的信号**。对这个信号进行傅里叶变换，即可知道指定频率，指定相位的信号的大小，即知道指定z层，指定y层，指定x层的质子的信号的大小。



信号会被填充到K空间。K空间是原始信号到图像的过渡。K空间中的每个采样点都包括整层内所有像素的信息。

不恰当的举例：频率编码类似合唱中不同音调的同学，相位编码类似合唱中不同快慢的同学，K空间的每个采样点，就是所有同学的整体合唱。K空间中，中心点表示这首合唱，所有同学音调相同，快慢一致，离原点越远，表示该维度上越不一致



# 重新理解

1946年，珀塞尔和布洛赫分别独立探测到了石蜡和水的磁共振信号（1952年诺贝尔物理学奖）。

核磁共振波谱学诞生，即利用磁共振现象测量物质内的成分。

1971年，达马迪安（医生）指出磁共振可以用来区分恶性肿瘤和正常组织。

1973年，劳特伯（化学家）描述了梯度磁场的重要构想。

1975年，曼斯菲尔德（物理学家）发展了梯度磁场的思路（2003年诺贝尔生理学奖）。

## 傅里叶变换

$$
F(\omega)=\int_{-\infty}^{\infty}f(t)e^{-i\omega_n t}dr
$$

任何一个周期函数，都可以视作一系列不同频率振幅的正弦波的叠加。——**傅里叶，1807年**

即**傅里叶级数**：
$$
\begin{flalign}
f(t)&=\sum_{n=0}^{\infty}a_n cos(n\omega t)+\sum_{n=0}^{\infty}b_n sin(n\omega t) \\
&=a_0+a_1cos(\omega t)+a_2cos(2\omega t)+...+b_1sin(\omega t)+b_2sin(2\omega t)+...
\end{flalign}
$$

> sin和cos都可以统称为正弦波，只是相位相差90°

想知道叠加信号由几个正弦波组组成，本质就是计算所有正弦波的系数$（a0, a1, a2, ..., b1, b2, ...）$

**系数求解公式**：
$$
\begin{align}
& a_0=\frac{2}{T}\int_0^T f(t)\,dt \\
& a_n=\frac{2}{T}\int_0^T f(t)cos(\omega_nt)\,dt \\
& b_n=\frac{2}{T}\int_0^T f(t)sin(\omega_nt)\,dt
\end{align}
$$
如何理解上面的系数求解公式？正交基

向量$\vec{a}\,(0,0,1)$和$\vec{b}\,(0,1,0)$正交，说明$\vec{a}$和$\vec{b}$**内积**为0

即$(0\times 0)+(0\times 1)+(1\times 0)=0$

**任意两个向量内积为零，而和自己的内积不为零，这样的向量就正交**

两个**无限维向量**(3,1,2,3,4,3,2,5,1,3,...)，(1,-2,-3,4,6,-7,8,-2,5,-8,...)内积为零，所以正交

**无限维向量**是什么？**函数**

所以连续函数的内积，仍然是函数上的无数个点，现相乘再相加的和：
$$
\begin{align}
 &=f(t1)g(t1)+f(t2)g(t2)+f(t3)g(t3)+f(t4)g(t4)+... \\
 &=\int f(t)g(t)\,dt \\
 &=0 \\ 
\end{align}
$$
 所以，可以认为$f(t)$和$g(t)$是一组正交基，因为它们的内积为零



回到傅里叶级数，
$$
\begin{flalign}
f(t)&=\sum_{n=0}^{\infty}a_n cos(n\omega t)+\sum_{n=0}^{\infty}b_n sin(n\omega t) \\
&=a_0+a_1cos(\omega t)+a_2cos(2\omega t)+...+b_1sin(\omega t)+b_2sin(2\omega t)+...
\end{flalign}
$$
很巧，**取任何一项，它们都和除自己外的其余项内积都为零**。

例如，取第2项和第3项，有：
$$
\begin{flalign}
&\int_{-\pi}^\pi cos(\omega t)\cdot cos(2\omega t)\,dt \\
&=0
\end{flalign}
$$
知道这些性质之后，就可以计算系数求解公式。

想要计算哪个系数，就让**该项**与**整个$f(t)$**内积，例如我想求系数$a_1$，有：
$$
\begin{align}
& \int_{-\pi}^{\pi}f(t)\cdot cos(\omega t)\,dt \\
&= \int_{-\pi}^{\pi}(a0\cdot cos(\omega t)+a_1cos(\omega t)\cdot cos(\omega t)+a_2cos(2\omega t)\cdot cos(\omega t)+...b_1sin(\omega t)\cdot cos(\omega t)+b_2sin(2\omega t)\cdot cos(\omega t)+...)\,dt \\
&= \int_{-\pi}^{\pi}a_1cos(\omega t)\cdot cos(\omega t)\,dt \\
&= a_1\pi \\
&即有： \\
& \int_{-\pi}^{\pi}f(t)\cdot cos(\omega t)\,dt = a_1\pi \\
&所以： \\
& a_1=\frac{1}{\pi}\int_{-\pi}^{\pi}f(t)\cdot cos(\omega t)\,dt \\
&通常写成周期T的形式： \\
& a_1=\frac{2}{T}\int_{0}^{T}f(t)\cdot cos(\omega t)\,dt
\end{align}
$$
求其他系数同理。

遍历所有项，就可以分解出所有系数。

利用正交基的内积为零的性质，**干掉其他项，留下自己人**，就是傅里叶变换的核心



但是在数学上，为了计算方便，傅里叶级数通常会写成**复数形式**：
$$
\begin{align}
f(t) &= \sum_{n=\infty}^{\infty}C_n e^{i\omega_n t} \\
&= C_1e^{i\omega_1 t}+C_2e^{i\omega_2 t}+C_3e^{i\omega_3 t}+... \\
& 虚数：i=\sqrt{-1}

\end{align}
$$
其中$e^{i\omega_n t}$，其实是引入了世界上最美公式的**欧拉公式**后的推导结果：
$$
e^{i\omega t} = cos\omega t + i\,sin\omega t
$$
所以傅里叶级数的复数形式可以写成：
$$
\begin{align}
f(t) &= \sum_{n=\infty}^{\infty}C_n e^{i\omega_n t} \\
&= C_1e^{i\omega_1 t}+C_2e^{i\omega_2 t}+C_3e^{i\omega_3 t}+... \\
&= C_1(cos\omega_1t+i\,sin\omega_1t)+C_2(cos\omega_2t+i\,sin\omega_2t)+C_3(cos\omega_3t+i\,sin\omega_3t)+...

\end{align}
$$
以上：$cos\omega_1t$，$sin\omega_1t$，$cos\omega_2t$，$sin\omega_2t$，$cos\omega_3t$，$sin\omega_3t$等，均为一组正交基

所以：$e^{i\omega_1 t}$，$e^{i\omega_2 t}$，$e^{i\omega_3 t}$等，也为一组正交基



由于用傅里叶级数求频率的适用范围是**周期函数**，而现实生活中处理的往往是**非周期的信号**。好在，非周期函数，**其实就是周期无限大的周期函数**。

所以令$T\to\infty$，经过一系列精密的推导，得到：

**（这里的精密推导不知道）**

**（这里的精密推导不知道）**

**（这里的精密推导不知道）**
$$
\begin{align}
& f(t)=\frac{1}{2\pi}\int_{-\infty}^{\infty}X_ne^{i\omega t}\,dt \\
& 相比于傅里叶级数，唯一的变化就是求和符号变成了对频率的积分 \\
& f(t) = \sum_{n=\infty}^{\infty}C_n e^{i\omega_n t}
\end{align}
$$
傅里叶级数分解的对象是周期函数，分解出来的正弦波频率并不连续。

而由于非周期函数周期无限大，分解出来的频率间隔就为0，是连续函数，**求和符号**也就变成了**积分**

为了求所有的系数$Xn$，还是让$f(t)$与**其对应的基函数**内积。例如为了求$X_1$，有：

**（这一步没有太懂为什么直接就能得到$X_1$）**

**（这一步没有太懂为什么直接就能得到$X_1$）**

**（这一步没有太懂为什么直接就能得到$X_1$）**
$$
\begin{align}
& X_1 = \int_{-\infty}^{\infty}f(t)\cdot e^{i\omega_1 t}\,dt \\

\end{align}
$$
但是这样求解的结果中具有复数$i$，所以引入了共轭复数（两个实部相等，虚部互为相反数的复数互为共轭复数），而$i$的共轭复数就是$-i$

即：
$$
\begin{align}
& X_1 = \int_{-\infty}^{\infty}f(t)\cdot e^{-i\omega_1 t}\,dt \\
& X_2 = \int_{-\infty}^{\infty}f(t)\cdot e^{-i\omega_2 t}\,dt \\
& X_3 = \int_{-\infty}^{\infty}f(t)\cdot e^{-i\omega_3 t}\,dt \\
&... \\
& X_n = \int_{-\infty}^{\infty}f(t)\cdot e^{-i\omega_n t}\,dt

\end{align}
$$
因为$e^{-i\omega t}$依旧和其他项正交，并且结果中还可以消掉虚数。



系数，其实就是信号幅值。所以$X_n$可以用$F(\omega)$表示，表示该频率下的幅值，即傅里叶变换公式：
$$
F(\omega) = \int_{-\infty}^{\infty}f(t)\cdot e^{-i\omega_n t}\,dt
$$
知道时域$f(t)$就可以得到频域$F(\omega)$的信息。

而之前推导得到的带有$X_n$的公式，将$X_n$替换成$F(\omega)$就可以得到反傅里叶变换：
$$
f(t)=\frac{1}{2\pi}\int_{-\infty}^{\infty}F(\omega)e^{i\omega t}\,dt
$$
将频域$F(\omega)$信息转换成时域$f(t)$信息

## 复平面理解傅里叶转换

无论什么时候，处理二维问题的时候，都可以通过引入复平面，在缠绕和旋转等研究中很好用。

复数的实部和虚部对应二维的x，y轴

著名的欧拉公式告诉我们：$e^{ni}$，就会落在“从右边开始，沿着半径为1的单位圆”逆时针走了n个单位长度的点上。
$$
\begin{align}
e^{ni} &= cos(n)+sin(n)i \\
e^{\pi i} &= cos(\pi)+sin(\pi)i=-1
\end{align}
$$


<img src="..\..\..\typora_images\image-20230828180027151.png" alt="image-20230828180027151" style="zoom:67%;" />

例如，想要描述一个在**单位圆**上**每秒钟转1圈**的旋转。就可以用 $e^{2\pi it}$ 来直接表示：

- $e$：自然常数，欧拉数，自然对数函数的底数
- $2\pi$：单位圆的周长
- $i$：虚数
- $t$：经过的时间

想要描述一个在单位圆上每秒转$f$圈（即旋转频率为$f$）的旋转。就可以用 $e^{2\pi ift}$来直接表示

- $e$：自然常数，欧拉数，自然对数函数的底数
- $2\pi$：单位圆的周长
- $i$：虚数
- $f$：旋转频率
- $t$：经过的时间

那么，为什么能这样表示呢？欧拉公式！

### 欧拉公式与初等群论

**数学经常在做的一件事就是，将只对自然数有意义的原始定义，扩展成为适用于各种数的定义。**

欧拉公式：
$$
e^{\pi i}=-1
$$
群论 (group theory)：研究对称性 (symmetry) 本质的一个领域 

#### 加法群

复平面上：

- $1+2$，表示向x轴（实数轴）正方向平移1个单位，再向x轴（实数轴）正方向平移2个单位

- $1+2+i$，表示向x轴（实数轴）正方向平移1个单位，再向x轴（实数轴）正方向平移2个单位，再向y轴（虚数轴）正方向平移1个单位

所以**从一个复数映射到另一个复数**，必定有其对应的**平移**方法

加法$x+y$，用来描述这种**平移**

#### 乘法群

复平面上：

- $1\times 3$，表示沿着x轴（实数轴）拉伸3倍
- $1\times \frac{1}{3}$，表示沿着x轴（实数轴）压缩3倍
- $1\cdot i$，表示逆时针旋转$90\degree$
- $1\times 3\times i$，表示先沿着x轴（实数轴）拉伸3倍，再逆时针旋转
- $i\times i$表示先逆时针旋转$90\degree$，再逆时针旋转$90\degree$；最后位置落在$-1$上，也说明$i\times i=1$

所以**从一个复数映射到另一个复数**，必定有其对应的**伸缩、旋转**的方法

乘法$x\cdot y$，用来描述这种**伸缩、旋转**

---

利用群论思想，既然加法群的平移作用以及乘法群的伸缩旋转作用都能够**使一个复数映射到另一个复数**

当使用**加法群**中的**平移**完成从**复数A到复数B**的映射之后，也一定存在**乘法群**中的**伸缩、旋转**完成从**复数A到复数B**的映射

$f(x+y)=f(x)\cdot f(y)$

此外，幂运算性质对群之间的关系非常重要，因为

它保证，如果我将2个平移作用复合，将应于2个输出的作用的复合

即$a^{x+y}=a^{x}\cdot a^{y}$

先规定，对于$a^{x}$，向上（y轴，虚数部）平移1个单位，即$a ^i$，映射为$\ln a^1$弧度的旋转

即：

- 对于函数$f(x)=2^x$，向上平移1个单位，即$2^i$，映射为$\ln 2$的弧度旋转

- 对于函数$f(x)=5^x$，向上平移1个单位，即$5^i$，映射为$\ln 5$的弧度旋转
- 对于函数$f(x)=e^x$，向上平移1个单位，即$e^i$，映射为$1$的弧度旋转
- 对于函数$f(x)=e^x$，向上平移$\pi$个单位，即$e^{\pi i}$，映射为$\pi$的弧度旋转

而**逆时针旋转$\pi$弧度的动作**表示原来$1+0i$的这个点，移动到了$-1+0i$ 上，即$-1$，从而完成：
$$
e^{\pi i}=-1
$$
**为什么是e呢？**答案在微积分里

**为什么是e呢？**答案在微积分里

**为什么是e呢？**答案在微积分里

总之，群论，提供了一种生动的形象的方式——**指数函数**通常会将**纯竖直（虚轴）平移**的加法作用，映射为**纯旋转**；从某种角度上，它们垂直于实数对应的伸缩作用；$e^x$会用一种特殊的方式做到这一点，它确保向上滑动$\pi$个单位恰好对应于$\pi$弧度的旋转，也就是和$-1$这个数关联的$180\degree$旋转

---

回到傅里叶变换。

在傅里叶变换的语境下，通常认为，旋转是沿着顺时针方向的，所以在$i$前面添加负号，得到$e^{-2\pi ift}$

现在拿一个信号幅度随时间变化的函数$g(t)$出来。

将两个式子相乘，得到：
$$
g(t)e^{-2\pi ift}
$$
上式意味着，这个旋转的复数依照函数值大小被缩放了，实现缠绕

缠绕起来的图像，我们希望得到的是图像的**质心**（3b1b的傅里叶变换中有具体思想）。那么，质心如何求呢？

我们的目的是要求质心，所谓**质心**，就是把每个采样点看作**复平面上的一个点**，最终要求的就是把所有点当作复数加起来，再除以样本点的总数，这样得到的复数，就表示质心位置。

先想象在这个旋转图像上进行多次采样，看看这些点在绕好的图像上处于什么位置。

然后把他们作为复数加起来，然后再除以采样点总数：
$$
\frac{1}{N}\sum_{k=1}^{N}g(t_k)e^{-2\pi ift}
$$

采样点越多，结果越准确，取极限时，拓展到积分，再除以时间区间的长度：
$$
\frac{1}{t_2-t_1}\int_{t1}^{t2}g(t)e^{-2\pi ift}\,dt
$$
上式和真正的傅里叶变换公式只有一个区别，就是多了前面的$\frac{1}{t_2-t_1}$这个部分，真正的傅里叶变换公式为：
$$
\hat g(\omega)=\int_{t1}^{t2}g(t)e^{-2\pi ift}\,dt
$$
也就是说，其实其表达的不是质心概念，而是将质心在乘上$t_2-t_1$；如果说原图像存在了$6s$，就把质心乘上6；物理上的效果就是如果某个频率持续了很长时间，这个傅里叶变换的**模**长就被放的很大。但是对于其他的频率来说，就算你稍微增大了一点，也会被抵消掉，因为持续时间足够长，缠绕的图像就更可能在圆上均匀的分布开。

# 回到核磁共振

## 二维傅里叶变换

平面波公式：
$$
f(x,y)=\alpha sin(\omega_xx+\omega_yy)
$$
平面波没有$时间t$的概念，只有表示$空间的x和y$，平面波描述的不是**时域信号**而是**空间域信号（空域信号）**，表示波随空间位置的变化而变化

通常平面波的空间频率习惯用u和v来表示，有：
$$
\omega_x=2\pi u \\
\omega_y=2\pi v \\
\begin{align}
f(x,y) &= \alpha sin(\omega_xx+\omega_yy) \\
&= \alpha sin2\pi(ux+vy)
\end{align}
$$
**二维傅里叶级数**：
$$
f(x,y)=\sum_{n=-\infty}^{\infty}\sum_{n=-\infty}^{\infty}C_{mn}e^{i(mux+nvy)}
$$
**二维傅里叶变换**：
$$
F(u,v)=\int\int f(x,y)e^{-2\pi i(ux+vy)}\,d(x,y)
$$


**二维傅里叶反变换**：
$$
f(x,y)=\frac{1}{4\pi^2}\int_{-\infty}^{\infty}\int_{-\infty}^{\infty}F(u,v)e^{2\pi i(ux+vy)}\,d(u,v)
$$
同理，我们依旧可以写出**三维傅里叶变换**和**三维傅里叶反变换**，但是由于三维傅里叶反变换的**计算量十分大**，实际引用可以忽略，所以核磁共振里面才需要进行**选层**，将处理对象变成二维。

在一维傅里叶变换里，我们通常是在工程上探测到**时域信号**，然后用傅里叶变换将它还原成**频域信号**；但是在二维傅里叶变换中，已知的是**空间频率域信号（空频域信号）**，需要用二维傅里叶反变换将它还原成**空间域信号（空域信号）**

## 核磁共振

核磁信号是一个**时域信号**，首要的任务就是转换成**空间频率域信号**。

首先选层，假设一个薄层中只有$4\times 4$个像素/质子，每个质子都产生一个核磁共振信号，16个信号（$S_1(t),S_2(t)...S_{16}(t)$）叠加在一起，就是我们能够探测到的**唯一信号**，即**整层信号**$S(t)$。

现在的问题变成了：如何通过这个**整层信号**还原每个**质子的密度**。

通过公式：

**（哪里的公式？）**

**（哪里的公式？）**

**（哪里的公式？）**
$$
S(t)=\int\rho(r)e^{-i\phi}\,dr \\
r是每个质子的空间信息
$$
我们知道决定每个区域磁共振信号强度的只有一个参数——$\phi$，即**宏观横向磁化分量**旋转时**累积相位**$\phi$

首先在y轴上施加一个梯度磁场，其磁场变化率记为$G_y$，则有：
$$
\begin{align}
&位置y处的磁场大小为：B_y=B_0+G_yy \\
&此处的质子进动频率：\omega_y=\gamma B_y=\gamma(B_0+G_yy) \\
&G_y作用的相位：\phi_y=\gamma G_yyt
\end{align}
$$
同样在x轴施加梯度磁场，其磁场变化率记为$G_x$，则有：
$$
G_x作用的相位：\phi_x=\gamma G_xxt
$$
而累积相位$\phi=\phi_x+\phi_y$

决定信号大小：
$$
\begin{align}
S(t) &= \int\rho(r)e^{-i(\phi_x+\phi_y)}\,dr \\
S(t) &= \int\int\rho(x,y)e^{-2\pi i(\gamma G_xt\cdot x+\gamma G_yt\cdot y)}\,d(x,y)
\end{align}
$$
上式与**二维傅里叶变换**十分相似，其中

$u类似于\gamma G_xt；v类似于\gamma G_yt$

但是，u和v表示2个正交维度，只有这样才能构建正交基，但是$\gamma G_xt$和$\gamma G_yt$意味着什么呢？核磁共振的精妙之处。

$G_x$和$G_y$并不是同时施加的

选层结束后，先施加$G_y$，这就是相位编码，让质子们先转一转，不同层（这里只沿着y轴的层）质子相位不同

然后关闭$G_y$，**打开$G_x$，同时对选层的核磁信号进行采样**

<img src="..\..\..\typora_images\image-20230903152733719.png" alt="image-20230903152733719" style="zoom:67%;" />

在这里，**$时间t$是变量**，完成4次采样后，关闭$G_x$

然后再次打开$G_y$，但是注意，此时$G_y$的大小相对上次发生了变化，例如更小了。同样维持一会，让质子们转一会

在这里，**$梯度磁场G_y$成了变量**，然后关闭$G_y$，打开$G_x$，同时进行第5次到第8次采样。

<img src="..\..\..\typora_images\image-20230903153209278.png" alt="image-20230903153209278" style="zoom:67%;" />

> 上图中描述$G_x$大小的箭头画反了，应该是左边的更长

这样的操作一共进行4轮。每次改变以此$G_y$，每次操作中进行4次采样

<img src="..\..\..\typora_images\image-20230903153523933.png" alt="image-20230903153523933" style="zoom:67%;" />

可以发现，两个梯度磁场作用下的累积相位，形式虽然是一样的，本质却是**磁场（$G_y$）**和**时间（$t$）**这两个变量决定的。两个毫不相干的变量，就可以对应数学上的两个维度。

通过这种操作，一维变量$\phi$成功被拓展成了二维，成功构建二维平面正弦波（空域信号）

并已知他们在y方向的频率（$\gamma G_yt$），以及x方向的频率（$\gamma G_xt$）

信号公式：
$$
S(t)=\int\int\rho(x,y)e^{-2\pi i(\gamma G_xt\cdot x+\gamma G_yt\cdot y)}\,d(x,y)
$$


因此，质子密度就可以通过二维傅里叶反变换直接求出：
$$
\rho(x,y)=\int\int S(t)e^{-2\pi i(\gamma G_xt\cdot x+\gamma G_yt\cdot y)}\,d(x,y)
$$
<img src="..\..\..\typora_images\image-20230903154946844.png" alt="image-20230903154946844" style="zoom:67%;" />

具体来说

16个采样点对应着16个不同**空间频率**的正弦波

<img src="..\..\..\typora_images\image-20230903155152547.png" alt="image-20230903155152547" style="zoom:67%;" />

16个采样点采样到的幅值大小$S_1$到$S_{16}$，对应每个正弦波的最大幅值大小

16个波叠加，就是最后的**空域信号**，即我们能看到的脑子图像
