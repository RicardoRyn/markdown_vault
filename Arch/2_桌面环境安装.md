# 桌面环境安装

滚，都可以滚！

```bash
pacman -Syu # 升级系统中全部包
```

通过 `vim ~/.bash_profile` 输入：

```bash
export EDITOR='vim'
```

## 1. 新建非root用户

```bash
useradd -m -G wheel -s /bin/bash ricardo
```

> `-m`: 创建用户的 home 目录（/home/ricardo），如果没有就新建。
> `-G wheel`: 将用户加入附加组 wheel。wheel 组在 Linux 中通常用于 允许使用 sudo。
> `-s /bin/bash`: 指定用户登录时的 默认 shell 为 bash。

设置用户密码：

```bash
passwd ricardo
```

使用 `vim` 编辑器通过 `visudo` 命令编辑 sudoers 文件：

```bash
EDITOR=vim visudo # 这里需要显式的指定编辑器，因为上面的环境变量还未生效
```

找到如下这样的一行，把前面的注释符号 # 去掉：

```
#%wheel ALL=(ALL:ALL) ALL
```

## 2. 开启 32 位支持库与 Arch Linux 中文社区仓库（archlinuxcn）

通过 `vim /etc/pacman.conf` 编辑。

去掉 `[multilib]` 一节中两行的注释，来开启 32 位库支持。

在文档结尾处加入下面的文字，来添加 archlinuxcn 源。推荐的镜像源（选一个即可）也一并列出：

```
[archlinuxcn]
Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch # 中国科学技术大学开源镜像站
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch # 清华大学开源软件镜像站
Server = https://mirrors.hit.edu.cn/archlinuxcn/$arch # 哈尔滨工业大学开源镜像站
Server = https://repo.huaweicloud.com/archlinuxcn/$arch # 华为开源镜像站
```

> archlinuxcn 仓库服务器位于欧洲，在中国大陆、中国香港、美国有镜像。

```bash
pacman -Syyu
```

重启并用刚刚创建的用户登录。

---

**补充知识：**

`pacman -Syu`: 常规更新

`pacman -Syyu`: 只在遇到问题或更换镜像时使用

`-S`: sync → 安装或更新软件包

`-y`: refresh → 同步软件包数据库（即更新本地数据库索引）

`-yy`: 强制刷新数据库，即使数据库看起来是最新的

`-u`: upgrade → 升级已安装的所有软件包

---

## 3. niri桌面

### 1. 安装必要软件

由于国内环境，需要通过igue获取订阅码，通过v2ray/v2raya开启透明代理

```bash
sudo pacman -S git kitty openssh
sudo pacman -S niri xdg-desktop-portal-wlr xdg-desktop-portal-gtk egl-wayland
sudo pacman -S firefox                                                     # 浏览器
sudo pacman -S adobe-source-han-serif-cn-fonts wqy-zenhei                  # 思源、文泉驿字体
sudo pacman -S noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra # noto开源字体及表情
sudo pacman -S archlinuxcn-keyring                                         # cn 源中的签名
sudo pacman -S alsa-utils alsa-firmware alsa-ucm-conf sof-firmware         # 声音固件
sudo pacman -S pipewire pipewire-pulse pipewire-jack                       # 声音固件
sudo pacman -S ntfs-3g                                                     # 使系统可以识别 NTFS 格式的硬盘
sudo pacman -S fcitx5-im fcitx5-chinese-addons fcitx5-material-color       # 中文输入法
```

通过 `vim ~/.config/environment.d/im.conf` 编辑：

```bash
# Wayland只需要
XMODIFIERS=@im=fcitx

# xorg则需要
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx
SDL_IM_MODULE=fcitx
GLFW_IM_MODULE=ibus
```

准备好这些之后，输入`niri --session`启动 niri 桌面。

修改 niri 配置文件（根据自己的需求）：

1. 能够启动kitty
2. 能够操作窗口

### 2. 翻！

```bash
sudo pacman -S v2ray v2raya
sudo systemctl enable --now v2raya
```

启动firefox，安装igue插件，获取订阅码。打开 `127.0.0.1:2017`一顿操作：

1. 大陆白名单
2. redirect
3. 大陆白名单
4. 防止DNS劫持（快速）
5. supervisor
6. 保持系统默认

随便找个 git 仓库试一试代理效果（git@github.com:RicardoRyn/markdown_vault.git）。

### 3. paru!

安装paru：

```bash
sudo pacman -S --needed base-devel
git clone https://aur.archlinux.org/paru.git
cd paru
makepkg -si
```

### 4. 优化

```bash
paru -S zen-browser-bin zen-browser-i18n-zh-cn
paru -S sublime-text-4
paru -S dgop brightnessctl cava cliphist gammastep
```

DankMaterialShell桌面

```bash
curl -fsSL https://install.danklinux.com | sh
dms greeter install
reboot
```

设置中文`vim .config/locale.conf`

```
LANG=zh_CN.UTF-8
LANGUAGE=zh_CN.UTF-8
LC_ADDRESS=zh_CN.UTF-8
LC_COLLATE=zh_CN.UTF-8
LC_CTYPE=zh_CN.UTF-8
LC_IDENTIFICATION=zh_CN.UTF-8
LC_MEASUREMENT=zh_CN.UTF-8
LC_MESSAGES=zh_CN.UTF-8
LC_MONETARY=zh_CN.UTF-8
LC_NAME=zh_CN.UTF-8
LC_NUMERIC=zh_CN.UTF-8
LC_PAPER=zh_CN.UTF-8
LC_TELEPHONE=zh_CN.UTF-8
LC_TIME=zh_CN.UTF-8
```

互换esc和cap键用 `keyd`

```bash
git clone https://github.com/rvaiya/keyd
cd keyd
make && sudo make install
sudo systemctl enable --now keyd
```

通过 `sudo vim /etc/keyd/default.conf` 添加配置：

```
[ids]

*

[main]

# Maps capslock to escape when pressed and control when held.
capslock = overload(control, esc)

# Remaps the escape key to capslock
esc = capslock
```

启动蓝牙：

```bash
paru -S bluez bluez-utils
sudo systemctl enable --now bluetooth
```

安装qq的.desktop文件：

```
[Desktop Entry]
Name=QQ
Exec=linuxqq --enable-platform=wayland --wayland-text-input-version=3 --enable-wayland-ime %U
Terminal=false
Type=Application
Icon=qq
StartupWMClass=QQ
Categories=Network;
Comment=QQ
```

安装wechat的.desktop文件：

```
[Desktop Entry]
Name=wechat
Name[zh_CN]=微信
Exec=env QT_IM_MODULE=fcitx SDL_IM_MODULE=fcitx GLFW_IM_MODULE=ibus /opt/wechat/wechat %U
StartupNotify=true
Terminal=false
Icon=/usr/share/icons/hicolor/256x256/apps/wechat.png
Type=Application
Categories=Utility;
Comment=Wechat Desktop
Comment[zh_CN]=微信桌面版
```

## 4. 安装设置 Timeshift

设置 Timeshift 快照：

```bash
sudo pacman -S timeshift
sudo systemctl enable --now cronie.service

timeshift
```

完成后建议执行下述指令删除 subvolid：

```bash
sudo sed -i -E 's/(subvolid=[0-9]+,)|(,subvolid=[0-9]+)//g' /etc/fstab
```

通过安装 `grub-btrfs` 包，可以实现在每次使用 `grub-mkconfig` 重新生成 GRUB 启动项时，自动添加快照的启动入口。
如果希望在 Timeshift 自动创建快照的能够同时自动生成启动项，可以通过以下命令运行 `grub-btrfsd.service` 并将其配置为自动启动：

```bash
sudo systemctl enable --now grub-btrfsd.service
```

由于该服务默认的监视路径为 `/.snapshots`，因此还需要对该路径进行修改，你需要：

1. 覆盖默认配置

```bash
paru -S grub-btrfs
sudo systemctl edit grub-btrfsd.service
```

在默认的光标位置，添加以下内容后保存并退出

```bash
[Service]
ExecStart=
ExecStart=/usr/bin/grub-btrfsd --syslog --timeshift-auto
```

2. 重载并重启服务：

```bash
sudo systemctl daemon-reload
sudo systemctl restart grub-btrfsd.service
```

> 目前（v24.06.3）Timeshift 创建的快照默认是可读可写，并且没有提供创建只读快照的功能。
>
> 如果你不是使用 Timeshift 对系统进行快照管理，而是使用其它工具，你可能会遇到由于创建了只读快照导致无法正常启动到快照系统的问题，你需要通过 btrfs property set 修改快照的读写属性才能解决。
>
> 对此，grub-btrfs 提供了一个initramfs hook，你可以添加这个名为 grub-btrfs-overlayfs 的 hook，使用 overlayfs 的方式启动只读快照。
>
> 这样每当启动到只读快照时，所有的写操作都会被重定向到 overlayfs 的 upper 层，也就是将数据写入到内存中，而不会影响到快照本身，就像 live-cd 一样。
>
> 你需要编辑 /etc/mkinitcpio.conf
>
> sudo -e /etc/mkinitcpio.conf
>
> 1
>
> 找到 HOOKS，并在列表末尾添加 grub-btrfs-overlayfs，就像这样:
>
> HOOKS=(base udev autodetect microcode modconf keyboard keymap consolefont block filesystems fsck resume numlock grub-btrfs-overlayfs)
>
> 1
>
> 并重新生成 initramfs:
>
> sudo mkinitcpio -P

## 5. 显卡驱动

### 1. 集显（intel）

```bash
sudo pacman -S mesa lib32-mesa vulkan-intel lib32-vulkan-intel
```

### 2. 独显（nvidia）

```bash
sudo pacman -S nvidia nvidia-settings lib32-nvidia-utils
```
