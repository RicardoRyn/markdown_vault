# 桌面环境安装

滚，都可以滚！

```bash
pacman -Syu # 升级系统中全部包
```

通过 `vim ~/.bash_profile` 输入：

```bash
export EDITOR='vim'
```

## 1. 新建非root用户

```bash
useradd -m -G wheel -s /bin/bash ricardo
```

> `-m`: 创建用户的 home 目录（/home/ricardo），如果没有就新建。
> `-G wheel`: 将用户加入附加组 wheel。wheel 组在 Linux 中通常用于 允许使用 sudo。
> `-s /bin/bash`: 指定用户登录时的 默认 shell 为 bash。

设置用户密码：

```bash
passwd ricardo
```

使用 `vim` 编辑器通过 `visudo` 命令编辑 sudoers 文件：

```bash
EDITOR=vim visudo # 这里需要显式的指定编辑器，因为上面的环境变量还未生效
```

找到如下这样的一行，把前面的注释符号 # 去掉：

```
#%wheel ALL=(ALL:ALL) ALL
```

## 2. 开启 32 位支持库与 Arch Linux 中文社区仓库（archlinuxcn）

通过 `vim /etc/pacman.conf` 编辑。

去掉 `[multilib]` 一节中两行的注释，来开启 32 位库支持。

在文档结尾处加入下面的文字，来添加 archlinuxcn 源。推荐的镜像源（选一个即可）也一并列出：

```
[archlinuxcn]
Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch # 中国科学技术大学开源镜像站
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch # 清华大学开源软件镜像站
Server = https://mirrors.hit.edu.cn/archlinuxcn/$arch # 哈尔滨工业大学开源镜像站
Server = https://repo.huaweicloud.com/archlinuxcn/$arch # 华为开源镜像站
```

> archlinuxcn 仓库服务器位于欧洲，在中国大陆、中国香港、美国有镜像。

```bash
pacman -Syyu
```

重启并用刚刚创建的用户登录。

---

**补充知识：**

`pacman -Syu`: 常规更新

`pacman -Syyu`: 只在遇到问题或更换镜像时使用

`-S`: sync → 安装或更新软件包

`-y`: refresh → 同步软件包数据库（即更新本地数据库索引）

`-yy`: 强制刷新数据库，即使数据库看起来是最新的

`-u`: upgrade → 升级已安装的所有软件包

---

## 3. （可选，保守）安装KDE桌面环境

```bash
pacman -S plasma-meta dolphin kitty
```

kde 默认安装的是 xorg ，如果想使用 wayland 的话安装以下包：

```bash
pacman -S plasma-workspace xdg-desktop-portal egl-wayland
```

开启 sddm.service 守护进程：

```bash
systemctl enable sddm
```

通过以下命令启动显示管理器或重启电脑，即可看到欢迎界面：

```bash
systemctl start sddm
```

重启电脑：

```bash
reboot
```

## 4. （可选，折腾）安装niri

安装paru：

```bash
sudo pacman -S --needed base-devel
git clone https://aur.archlinux.org/paru.git
cd paru
makepkg -si

sudo pacman -S archlinuxcn-keyring                      # cn 源中的签名（archlinuxcn-keyring 在 archlinuxcn）
```

```bash
paru -S kitty git
paru -S zen-browser-bin zen-browser-i18n-zh-cn
paru -S clash-verge-rev-bin
paru -S niri xdg-desktop-portal xdg-desktop-portal-gtk egl-wayland

# dms桌面
curl -fsSL https://install.danklinux.com | sh
dms greeter install
```

设置中文`vim .config/locale.conf`

```
LANG=zh_CN.UTF-8
LANGUAGE=zh_CN.UTF-8
LC_ADDRESS=zh_CN.UTF-8
LC_COLLATE=zh_CN.UTF-8
LC_CTYPE=zh_CN.UTF-8
LC_IDENTIFICATION=zh_CN.UTF-8
LC_MEASUREMENT=zh_CN.UTF-8
LC_MESSAGES=zh_CN.UTF-8
LC_MONETARY=zh_CN.UTF-8
LC_NAME=zh_CN.UTF-8
LC_NUMERIC=zh_CN.UTF-8
LC_PAPER=zh_CN.UTF-8
LC_TELEPHONE=zh_CN.UTF-8
LC_TIME=zh_CN.UTF-8
```

互换esc和cap键用`keyd`

安装输入法：

```bash
sudo pacman -S fcitx5-im             # 输入法基础包组
sudo pacman -S fcitx5-chinese-addons # 官方中文输入引擎
sudo pacman -S fcitx5-material-color # 输入法主题
```

通过 `vim ~/.config/environment.d/im.conf` 编辑：

```bash
XMODIFIERS=@im=fcitx
```


## 5. 安装基础功能包

通过 `vim ~/.bashrc` 编辑：

```bash
sudo pacman -S neovim
export EDITOR='nvim'
```

```bash
sudo pacman -S clash-verge-rev-bin

sudo pacman -S sof-firmware alsa-firmware alsa-ucm-conf # 声音固件
sudo pacman -S ntfs-3g                                  # 使系统可以识别 NTFS 格式的硬盘
sudo pacman -S archlinuxcn-keyring                      # cn 源中的签名（archlinuxcn-keyring 在 archlinuxcn）

sudo pacman -S adobe-source-han-serif-cn-fonts wqy-zenhei                  # 安装几个开源中文字体。
sudo pacman -S noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra # 安装谷歌开源字体及表情

sudo pacman -S zen-browser-bin zen-browser-i18n-zh-cn
sudo pacman -S steam # 游戏商店。稍后看完显卡驱动章节再使用

# # 可选
# sudo pacman -S gwenview # 图片查看器
# sudo pacman -S ark # 压缩软件。在 dolphin 中可用右键解压压缩包
# sudo pacman -S packagekit-qt6 packagekit appstream-qt appstream # 确保 Discover（软件中心）可用，需重启
```


安装输入法：

```bash
sudo pacman -S fcitx5-im             # 输入法基础包组
sudo pacman -S fcitx5-chinese-addons # 官方中文输入引擎
sudo pacman -S fcitx5-material-color # 输入法主题
```

通过 `vim ~/.config/environment.d/im.conf` 编辑：

```bash
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx
SDL_IM_MODULE=fcitx
GLFW_IM_MODULE=ibus
```

如果使用 Wayland 而非 X11：

```bash
XMODIFIERS=@im=fcitx
```

启动蓝牙：

```bash
sudo systemctl enable --now bluetooth
```

## 6. 安装设置 Timeshift

设置 Timeshift 快照：

```bash
sudo pacman -S timeshift
sudo systemctl enable --now cronie.service

timeshift
```

完成后建议执行下述指令删除 subvolid：

```bash
sudo sed -i -E 's/(subvolid=[0-9]+,)|(,subvolid=[0-9]+)//g' /etc/fstab
```

通过安装 `grub-btrfs` 包，可以实现在每次使用 `grub-mkconfig` 重新生成 GRUB 启动项时，自动添加快照的启动入口。
如果希望在 Timeshift 自动创建快照的能够同时自动生成启动项，可以通过以下命令运行 `grub-btrfsd.service` 并将其配置为自动启动：

```bash
sudo systemctl enable --now grub-btrfsd.service
```

由于该服务默认的监视路径为 `/.snapshots`，因此还需要对该路径进行修改，你需要：

1. 覆盖默认配置

```bash
sudo systemctl edit grub-btrfsd.service
```

在默认的光标位置，添加以下内容后保存并退出

```bash
[Service]
ExecStart=
ExecStart=/usr/bin/grub-btrfsd --syslog --timeshift-auto
```

2. 重载并重启服务：

```bash
sudo systemctl daemon-reload
sudo systemctl restart grub-btrfsd.service
```

> 目前（v24.06.3）Timeshift 创建的快照默认是可读可写，并且没有提供创建只读快照的功能。
>
> 如果你不是使用 Timeshift 对系统进行快照管理，而是使用其它工具，你可能会遇到由于创建了只读快照导致无法正常启动到快照系统的问题，你需要通过 btrfs property set 修改快照的读写属性才能解决。
>
> 对此，grub-btrfs 提供了一个initramfs hook，你可以添加这个名为 grub-btrfs-overlayfs 的 hook，使用 overlayfs 的方式启动只读快照。
>
> 这样每当启动到只读快照时，所有的写操作都会被重定向到 overlayfs 的 upper 层，也就是将数据写入到内存中，而不会影响到快照本身，就像 live-cd 一样。
>
> 你需要编辑 /etc/mkinitcpio.conf
>
> sudo -e /etc/mkinitcpio.conf
>
> 1
>
> 找到 HOOKS，并在列表末尾添加 grub-btrfs-overlayfs，就像这样:
>
> HOOKS=(base udev autodetect microcode modconf keyboard keymap consolefont block filesystems fsck resume numlock grub-btrfs-overlayfs)
>
> 1
>
> 并重新生成 initramfs:
>
> sudo mkinitcpio -P

## 7. v2ray和v2rayA

dddd

```bash
sudo pacman -S v2ray v2raya
sudo systemctl enable --now v2raya

# 或者
paru -S clash-verge-rev-bin
```

## 8. 显卡驱动

### 1. 集显（intel）

```bash
sudo pacman -S mesa lib32-mesa vulkan-intel lib32-vulkan-intel
```

### 2. 独显（nvidia）

```bash
sudo pacman -S nvidia nvidia-settings lib32-nvidia-utils # 必须安装
```

### 3. 双显卡

🚧 施工中
