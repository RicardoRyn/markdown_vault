# 原始数据的3D重构

## 结构像

以下示例中使用的数据为 **AFNI_data6**

在终端中键入：

```bash
cd AFNI_data6  # 其中结构项的文件夹是DICOM_T1
cd DICOM_T1
vim run_Dimon.csh  # 用vim（一种编辑器）打开脚本文件run_Dimon.csh
```

vim打开会显示以下代码：

```bash
uniq_images I*[0123456789] > uniq_image_list.txt  # I开头（*为通配符）数字结尾的文件会被写进txt文档

Dimon -infile_list uniq_image_list.txt \  # 输入的文件的名字，即刚刚生成的txt文件
      -gert_create_dataset             \
      -gert_write_as_nifti             \  # 把生成的文件的结构项，写成nifti格式
      -gert_to3d_prefix T1.3D          \  # 即将生成的结构项的文件的名字，即T1.3D
      -gert_outdir ..                  \  # 将生成的T1.3D.nii文件写入父目录（..代表父目录）
      -dicom_org                       \
      -use_last_elem                   \
      -save_details Dimon.details      \
      -gert_quit_on_err
      
\rm uniq_image_list.txt  # 将刚刚生成的txt文档删除掉
```

想要运行run_Dimon.csh脚本，则在终端中键入：

```bash
./run_Dimon.csh
```

终端中显示（部分）：

```bash
final run statistics:
    volume info     :
        slices      : 171  # 表示具有171个2D图像
        z_first     : 78.7  # 表示从z轴78.7开始扫描
        z_last      : -91.3  # 一直扫描到-91.3
        z_delta     : 1  # 层厚为1
        oblique     : yes
        mos_nslices : 0 
        
    run # 801 : volumes =   1, first file (#0) = I1000000
```

使用afni打开结构项图像，键入：

```bash
afni ../T1.3D.nii  # 之前生成的nifti格式的结构项文件（因为在父目录中，所以用../）
```



## 功能像

将之前重构结构项的脚本复制到功能项文件夹中，键入：

```bash
cp run_Dimon.csh ../EPI_run1/
```

接下来需要进行修改才能转为运行功能项脚本

用vim打开复制过去的run_Dimon.csh脚本，修改后如下：

```bash
uniq_images 8H*.dcm > uniq_image_list.txt  # 功能项的2D文件都是以8H开头（*为通配符），.dcm结尾的文件

Dimon -infile_list uniq_image_list.txt \  # 输入的文件名，即上一行代码生成的txt文档
      -gert_create_dataset             \
      -gert_write_as_nifti             \  # 把生成的文件的功能项，写成nifti格式
      -gert_to3d_prefix epi_r1          \  # 即将生成的功能项的文件的名字，即epi_r1
      -gert_outdir ..                  \  # 将生成的epi_r1.nii文件写入父目录（../代表父目录）
      -dicom_org                       \
      -use_last_elem                   \
      -save_details Dimon.details      \
      -gert_quit_on_err

\rm uniq_image_list.txt  # 将刚刚生成的txt文档删除掉
```

在终端中运行该脚本，键入：

```bash
./run_Dimon.csh
```

终端显示（部分）：

```bash
final run statistics:
    volume info     :
        slices      : 34  # 表示具有34个2D图像
        z_first     : -43.93  # 表示从z轴-43.93开始扫描
        z_last      : 71.57  # 一直扫描到71.57
        z_delta     : 3.5  # 层厚3.5
        oblique     : no
        mos_nslices : 0 

    run #   3 : volumes =  67, first file (#0) = 8HRBRAINAx2DGRE-00001.dcm  # 一次run有67个整脑，经过了67个TR
```

使用afni打开功能项图像，键入：

```bash
afni ../epi_r1.nii  # 之前生成的nifti格式的功能项文件（因为在父目录中，所以用../）
```

功能项的图像分辨率更低，所以看起来比结构项更模糊

## to3d脚本

这些DICOM的脚本实际上是读取输入的文件，然后根据输入文件里的原信息决定每一个文件在大脑中的位置及扫描方式

然后，它会写一个to3d的脚本，名称为GERT_Reco_dicom_003（该示例为功能项，结构项中对应的脚本是GERT_Reco_dicom_801）

该脚本是真正在做重构工作的一个命令

通过vim打开GERT_Reco_dicom_003脚本：

```bash
#!/bin/tcsh

# This script was automatically generated by 'Dimon'.
#
# Please modify the following options for your own evil uses.

set OutlierCheck = ''         # use '-skip_outliers' to skip
set OutDir       = '..'     # output directoy for datasets


#---------- make sure output directory exists ----------
test -d $OutDir || mkdir -p $OutDir


#------- create dataset for run #3 -------
to3d -quit_on_err -prefix epi_r1.nii  \
     -time:zt 34 67 3.0sec alt+z       \  # zt表示扫描方式；34表示具有34个2D图像；67表示一次run有67个整脑；TR为3秒；alt+z表示沿着z轴进行隔层扫描
     -use_last_elem                \
     -@ < dimon.files.run.003

mv epi_r1.nii $OutDir
```



