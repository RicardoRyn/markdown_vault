Topup是一个工具，用来“评估 estimating”和“校正 correcting”失真。什么样的失真？“由磁敏感导致的失真 susceptibiliy induced distortions”

# 一、由磁敏感导致的离共振场

The susceptibility-induced off-resonance field

**离共振场/失谐场 off-resonance field：你（扫描仪）认为的磁场和实际磁场之间的差异。可以把它看作“实际磁场 actual field”减去“名义磁场 nominal field”之后得到的差异场**

磁场的单位通常是特斯拉，但是对于离共振场来说，这不是一个有效的单位，离共振场通常是微量级别的特斯拉。离共振场的单位采用赫兹Hz，1Hz的离共振场表示：相比于没有离共振场（完美情况），氢原子的进动速度快了1Hz

大部分体素中，离共振场为0，即该体素的信号将根据”梯度 gradients“表现，正如扫描仪期望的那样。但是对于部分体素，离共振场不为0。这意味着该体素将持续获得相位。

> 例如：如果某个体素的离共振场为100Hz，意味着它每0.01s，就会获得$2\pi$的相位

**产生离共振场的原因：当头部放置在扫描仪中时，会略微”抵抗磁化 resist magnetisation“**

所以头部中，那些远离气腔的组织，磁场会显得比较平坦，只是轻微低于我们期望的磁场强度（例如3T）。这是比较好的情况

而气腔中（例如鼻腔、耳道）及其周围，磁场在空间上会快速变化，值会超过100Hz。这是比较差的情况



# 二、EPI成像中的失真

EPI成像在单次激发后，获取图像所需的所有回波（即所有的k空间）

> 其他序列每次激发只会获取一个回波（即k空间中的线）

EPI可以在几十ms中获取一张图像，在1~2s中获取整个全脑（图像堆栈）。”其他序列做得到吗？“

**这种快速采集的能力能够提高时间分辨率，从而跟踪功能的变化，也能采集大量图像来表征水的弥散**

但是EPI对离共振场的敏感性很高。

这是因为，在相对较长的时间中，离共振场可以转化成相位差。这里的”相对较长时间“是指“激发（重聚焦脉冲）”和“不同k空间回波”之间的时间差。对于大多数序列来说，该差异为0，即对于所有回波来说，“激发”和“回波采集”之间的时间差为0，即同时。这意味着至少在相位编码方向PE上，没有失真。

但是对于EPI来说，单次激发，接着是一系列回波的采集（每个回波都代表着特定时间点的磁共振信号，反映了不同的空间信息），每个回波信号采集之前，会有一个小的**相位编码脉冲（PE-blip）**，也叫做**相位增量脉冲**。这个脉冲使磁共振信号的相位发生微小变化，以便在不同的空间位置上获得相位编码。这些相位编码信息帮助生成二维或三维的图像。

但是在具有离共振场的voxel中，磁共振信号会以不同于预期的频率进动。因此，在连续回波的采集中，体素中的相位不仅受到正常的相位编码脉冲（PE-blip）的影响，还会因为离共振场而发生额外的相位变化。具体来说，这种相位的额外变化量等于**离共振场的大小**乘以**两次回波采集之间的时间**

> 所以topup处理需要指定Echo spacing
>
> 举例：假设PE为A-P方向，假设PE_blips是正的，即越靠近Anterior的场，强度更高。所以越Anterior的voxel中，相位积累越多。这个时候，如果正的离共振场存在，就会导致相位额外积累，比预期的更大，导致图像失真，往Anterior方向靠。

失真位移的大小（单位为体素），是离共振场强（单位Hz）与“每个体素的带宽 Bandwidth per voxel（单位Hz/voxel）”的乘积。

>Bandwidth per voxel是一个数字，告诉你多少Hz的离共振场强将导致信号位移1个体素。一般在10~40Hz/voxel之间。这个值也是total readout time的倒数。
>
>total readout time是指第一个回波中心与最后一个回波中心间隔的时间

所以为了知道图像是如何失真的，需要知道：

1. 离共振场强度（未知）

2. 相位编码方向（从序列中读出）

3. Bandwidth per voxel，或者等价的Total readout time（从序列中读出）

   

# 三、topup如何评估以及校正失真

通过2个PE方向相反的“自旋回波EPI SE-EPI”图像，可以知道每个体素的信号失真位移量相同，但是方向相反。

所以对于图像空间中的某个点x，存在一个位移d，使得2个图像中的$x+d$和$x-d$的点的强度完全相同。所以最终只需要计算这个位移场$d(x)$

topup的本质就是一个非线性配准。只是受到限制，仅仅在PE方向上进行。通过“金字塔方法 pyramid approach”和“平滑性约束 smoothness constraints”来提高鲁棒性和有效性。

> **金字塔方法 pyramid approach**：是一种多尺度处理技术，通常用于图像处理和计算机视觉领域。在金字塔方法中，图像被分解为不同的分辨率层级（从高到低），然后在这些不同的层级上分别进行处理。这样可以在低分辨率层级上处理大范围的结构信息，在高分辨率层级上处理细节信息。通过在不同的尺度上进行处理，金字塔方法可以提高处理算法的效率和准确性，尤其是在处理大规模数据时。它可以帮助算法从粗略到精细地调整和优化估计结果。
>
> **平滑性约束 smoothness constraints**：一般来说，离共振场都是受到“平滑度和连续性约束 smoothness and continuity constraints”的，即场不会突然出现和突然中断，这一点会用于判断并帮助校正。

位移场$d(x)$计算出来后，通过BandwidthPerPixel/TotalReadoutTime，可以转化成离共振场，单位为Hz。**实际上，已知位移场就已经能够帮助我们进行图像校正了，rescale成的离共振场通常很少需要**。

topup的一个重要特征是拥有一个“内部运动模型 internal movement model”，能够区别：

- 被试头动导致的正反相图像之间的差异
- 离共振场的存在导致的正反相图像之间的差异



# 四、其他

为什么topup所需要的acqparams.txt文件中，第三个轴上的值必须是0，否则会报错

解答：

topup和eddy假设第三个州对应slices，特别是eddy中，包括“slice-to-volume运动校正”，因此相位编码被认为不可能发生在第三个轴上。

> 参考：https://community.mrtrix.org/t/topup-phase-encode-directions-are-f-h-and-h-f/2562
